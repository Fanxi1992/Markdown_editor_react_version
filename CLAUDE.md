# 公众号 Markdown 编辑器

一个专为微信公众号设计的 Markdown 编辑器，支持实时预览和一键复制富文本格式到公众号后台。

## 项目概述

这是一个纯前端的 Markdown 编辑器，可以将标准 Markdown 文本转换为适合微信公众号的富文本格式。支持 13 种精心设计的样式主题，每种主题都针对公众号的阅读体验进行了优化。

## 核心功能

### 1. Markdown 渲染
- 使用 `markdown-it` 进行 Markdown 解析
- 支持完整的 Markdown 语法（标题、列表、引用、代码块、表格等）
- 实时预览渲染结果

### 2. 样式系统
提供 13 种预设样式主题：
- **经典公众号系列**：默认、技术、优雅、深度阅读
- **传统媒体系列**：杂志风格、纽约时报、金融时报、Jony Ive
- **现代数字系列**：Wired 连线、Medium 长文、Apple 极简、Anthropic Claude、AI Coder 特调

每个样式都包含完整的元素定义（标题、段落、列表、引用、代码、表格、图片等）

### 3. 图片处理

#### 连续图片网格布局（类似朋友圈）
- **触发条件**：2张或以上连续的图片
- **布局规则**：
  - 2张图片：并排两列（50% + 50%）
  - 3张图片：一行三列（33.33% × 3）
  - 4张图片：2×2 网格
  - 5张及以上：3列网格布局

#### 图片高度限制
- **单张图片**：最大高度 600px
- **网格布局中的图片**：最大高度 360px（单行）
- 所有图片保持宽高比，使用 `object-fit: contain`

#### Base64 转换
- 复制到公众号时，自动将所有图片转换为 Base64 编码
- 避免公众号后台无法访问外链图片的问题
- 支持失败重试和错误提示

### 4. 公众号兼容性处理

#### Grid 转 Table
- **问题**：公众号编辑器不支持 CSS Grid 布局
- **解决方案**：复制时自动将 Grid 布局转换为 Table 布局
- **实现位置**：`app.js` 中的 `convertGridToTable()` 方法
- **转换逻辑**：
  ```javascript
  预览阶段：CSS Grid（现代、美观）
           ↓
  复制到公众号：HTML Table（兼容、可靠）
  ```

#### 样式内联化
- 所有 CSS 样式都转换为内联样式（inline style）
- 确保公众号编辑器能够正确识别和保留样式
- 不使用 CSS 类名或外部样式表

### 5. 代码高亮
- 使用 `highlight.js` 进行语法高亮
- macOS 风格的代码块装饰（红黄绿三色圆点）
- 支持多种编程语言
- 深色主题背景（#383a42）

### 6. 响应式设计

#### 桌面端（> 1024px）
- 左右分栏布局
- 编辑器在左，预览在右

#### 平板端（769px - 1024px）
- 保持左右分栏
- 调整内边距优化显示

#### 移动端（≤ 768px）
- **上下布局**
- 编辑器在上（占 40% 高度）
- 预览在下（可滚动）
- 隐藏部分UI元素（星标按钮、提示文字）
- 全宽按钮和选择器

### 7. 其他功能
- **样式收藏**：支持收藏常用样式，使用 localStorage 持久化
- **文件上传**：支持直接上传 .md 或 .markdown 文件
- **一键复制**：点击按钮即可复制富文本到剪贴板
- **Toast 提示**：操作反馈（成功/失败/处理中）

## 技术栈

- **前端框架**：Vue 3（CDN 引入，无需构建）
- **Markdown 解析**：markdown-it 14.0.0
- **代码高亮**：highlight.js 11.9.0
- **样式**：纯 CSS（CSS Variables + 内联样式）
- **部署**：静态文件，可用任何 HTTP 服务器

## 文件结构

```
公众号编辑器/
├── index.html        # 主页面，包含 UI 和样式
├── app.js           # Vue 应用逻辑和核心功能
├── styles.js        # 13 种样式主题配置
├── start.sh         # 本地开发服务器启动脚本
├── README.md        # 项目说明文档
├── LICENSE          # 许可证
└── CLAUDE.md        # 项目技术文档（本文件）
```

## 关键技术实现

### 1. 图片分组算法
```javascript
// 位置：app.js -> groupConsecutiveImages()
// 功能：识别连续的图片并分组
// 算法：
1. 遍历 DOM 子元素，找出所有图片（包括 <p><img></p> 结构）
2. 按索引位置判断是否连续（允许中间有1个空白节点）
3. 将连续的图片归为一组
4. 对每组图片创建网格布局（group.length >= 2）
```

### 2. 样式应用流程
```javascript
// 位置：app.js -> renderMarkdown() -> applyInlineStyles()
// 流程：
Markdown 输入
    ↓
markdown-it 解析为 HTML
    ↓
应用选中样式的内联 CSS
    ↓
处理图片网格布局
    ↓
包裹容器样式
    ↓
渲染到预览区
```

### 3. 复制到公众号流程
```javascript
// 位置：app.js -> copyToClipboard()
// 流程：
获取渲染后的 HTML
    ↓
将 Grid 转换为 Table（convertGridToTable）
    ↓
图片转 Base64（convertImageToBase64）
    ↓
包裹 section 容器（如有背景色）
    ↓
简化代码块结构
    ↓
列表项扁平化
    ↓
写入剪贴板（text/html + text/plain）
```

## 样式配置规范

每个样式主题的配置结构（`styles.js`）：
```javascript
{
  'style-key': {
    name: '样式显示名称',
    styles: {
      container: '容器样式',
      h1: '一级标题样式',
      h2: '二级标题样式',
      // ... 更多元素
      img: 'max-width: 100%; max-height: 400px; height: auto; display: block; ...',
      // 所有样式必须是完整的内联CSS字符串
    }
  }
}
```

## 约束和限制

1. **图片处理**
   - 单张图片最大高度：400px
   - 网格图片最大高度：360px
   - 所有图片保持原始宽高比

2. **公众号兼容性**
   - 不支持：CSS Grid, Flexbox（部分）, CSS Variables
   - 必须使用：内联样式、Table 布局
   - 图片必须：Base64 编码或公众号可访问的URL

3. **浏览器要求**
   - 需要支持 ES6+
   - 需要支持 Clipboard API
   - 需要支持 Fetch API

## 开发指南

### 本地运行
```bash
# 使用 Python 启动服务器
python3 -m http.server 8080

# 或使用提供的脚本
./start.sh

# 访问 http://localhost:8080
```

### 添加新样式主题
1. 在 `styles.js` 中添加新的样式配置对象
2. 在 `index.html` 的 `<select>` 中添加对应的 `<option>`
3. 确保所有必需的元素样式都已定义
4. 测试各种 Markdown 元素的渲染效果

### 修改图片布局
1. **网格布局逻辑**：`app.js -> groupConsecutiveImages()`
2. **网格列数规则**：根据图片数量判断（2列、3列等）
3. **高度限制**：修改 `max-height` 值
4. **Grid 转 Table**：`app.js -> convertGridToTable()`

### 调整公众号兼容性
1. 所有新增的 CSS 特性都要检查公众号支持情况
2. 复制功能中可能需要额外的转换步骤
3. 测试方法：实际粘贴到公众号编辑器验证

## 常见问题

### Q1: 为什么预览正常，但粘贴到公众号后图片布局乱了？
A: 公众号不支持 CSS Grid。已实现自动转换为 Table 布局，确保 `convertGridToTable()` 正确执行。

### Q2: 图片在公众号中显示不出来怎么办？
A: 复制时会自动转为 Base64。如果失败，检查图片 CORS 策略或使用公众号素材库的图片。

### Q3: 如何调整图片高度限制？
A:
- 单张图片：修改 `styles.js` 中所有 `img` 样式的 `max-height` 值
- 网格图片：修改 `app.js -> groupConsecutiveImages()` 中的 `max-height` 值

### Q4: 移动端布局如何调整？
A: 修改 `index.html` 中的媒体查询（@media）样式，调整 `#app` 的 grid 布局和各面板的高度比例。

## 未来改进方向

- [ ] 支持自定义样式主题
- [ ] 支持图片上传到云存储
- [ ] 支持更多 Markdown 扩展语法
- [ ] 添加撤销/重做功能
- [ ] 支持草稿自动保存
- [ ] 添加导出为图片功能
- [ ] 支持多人协作编辑

## 维护记录

### 最近更新
- 2025-10-13: 修复公众号编辑器样式兼容性（添加 !important 强制样式）
- 2025-10-13: 调整单张图片最大高度为 400px（之前为 600px）
- 2025-10-13: 添加连续图片网格布局功能
- 2025-10-13: 实现 Grid 转 Table 兼容性处理
- 2025-10-13: 优化移动端响应式布局
- 2025-10-13: 调整图片高度限制（单张400px，网格360px）

---

**注意**：本文档由 Claude 生成，记录项目的技术架构和实现细节，供开发和维护参考。
